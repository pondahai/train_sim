# train_sim

# 簡易 3D 電車模擬器
![image](https://github.com/user-attachments/assets/96b53e52-4b1d-4ae0-b5f8-b43e64f5115a)

這是一個使用 Python、Pygame 和 PyOpenGL 建立的基礎 3D 電車模擬器。  
使用者可以在一個由 `scene.txt` 文件定義的 3D 環境中駕駛電車。  
全程用gemini-2.5-pro vibe coding完成  

## 功能特色

*   **3D 環境渲染:** 使用 PyOpenGL 進行基本的 3D 場景渲染。
*   **電車物理模擬:**
    *   包含加速度、煞車、自然摩擦力。
    *   最高速度限制。
    *   可沿預定軌道行駛。
*   **自訂軌道與場景:**
    *   透過 `scene.txt` 文件定義軌道（直線、彎道）和場景物件。
    *   支援軌道坡度。
    *   可放置建築物（立方體）、圓柱體和樹木等靜態物件。
    *   支援物件紋理貼圖（需放置於 `textures` 資料夾）。
*   **駕駛艙視角:**
    *   提供第一人稱駕駛視角。
    *   包含基本的儀表板顯示（速度表、操作桿）。
*   **視角控制:** 使用滑鼠自由調整視角（可鎖定/解鎖）。
*   **HUD 顯示:**
    *   可選的小地圖（顯示軌道、物件和電車位置/方向）。
	*   小地圖可套圖(預設檔名map.png，一個像素等於模擬世界一個單位(公尺))
    *   可選的座標顯示（顯示電車在世界中的 X, Y, Z 座標）。
*   **動態場景載入:**
    *   可手動觸發（按 `R`）重新載入 `scene.txt`。
    *   自動偵測 `scene.txt` 的變更並重新載入。
*   **其他控制:**
    *   可切換地面網格的顯示。
    *   可切換軌道是否循環。

## 系統需求

*   Python 3.x
*   Pygame
*   PyOpenGL
*   NumPy

## 安裝依賴

建議在虛擬環境中安裝：

```bash
# 建立虛擬環境 (可選)
python -m venv venv
# 啟用虛擬環境 (Windows)
.\venv\Scripts\activate
# 啟用虛擬環境 (macOS/Linux)
source venv/bin/activate

# 安裝必要的函式庫
pip install pygame PyOpenGL numpy
```

## 如何執行

1.  確保 `scene.txt` 檔案和 `textures` 資料夾（包含所需的 `.png` 紋理檔）與 `main.py` 在同一目錄下。
2.  開啟終端機或命令提示字元，進入專案目錄。
3.  執行主程式：

    ```bash
    python main.py
    ```

## 操作控制

*   **`W` / `↑` (向上箭頭):** 加速電車
*   **`S` / `↓` (向下箭頭):** 煞車
*   **`滑鼠滾輪向上/下`:** 微調增加/減少當前速度
*   **`滑鼠移動`:** (當滑鼠解鎖時) 調整視角方向
*   **`Tab`:** 切換滑鼠鎖定/解鎖狀態 (影響視角控制和滑鼠指標可見性)
*   **`Esc`:** 退出模擬器
*   **`G`:** 切換地面網格的顯示/隱藏
*   **`L`:** 切換軌道循環模式 (到達終點後是否回到起點)
*   **`R`:** 手動重新載入 `scene.txt` 檔案
*   **`M`:** 切換小地圖的顯示/隱藏
*   **`I`:** 切換左上角座標資訊的顯示/隱藏
*   **`Page Up`:** 放大 (Zoom In) 小地圖
*   **`Page Down`:** 縮小 (Zoom Out) 小地圖

## `scene.txt` 檔案格式說明

`scene.txt` 用於定義軌道路線和場景中的靜態物件。

*   以 `#` 開頭的行是註解，會被忽略。
*   空白行會被忽略。
*   指令不分大小寫。
*   座標系統：通常 X 和 Z 構成水平面，Y 軸代表垂直高度。
*   角度單位：度 (degrees)。

### 地圖指令

1. **`map <file name> <width offset> <height offset> <scale>`**
    * 設定小地圖的底圖，一像素等於一個世界單位
    * `<file name>` 圖檔名稱
    * `<width offset>` 起點在地圖上的橫向偏移值
    * `<height offset>` 起點在地圖上的縱向偏移值
    * `<scale>` 圖檔顯示比例
  
### 軌道指令 (依序定義路線)

軌道指令會基於上一段軌道的結束位置和角度繼續建立。

1.  **`start <x> <y> <z> <angle_deg>`**
    *   (可選) 設定軌道的起始點和初始方向。
    *   `x, y, z`: 起始點的世界座標。
    *   `angle_deg`: 起始方向角度 (繞 Y 軸旋轉，0 度沿 +X)。
    *   如果未提供，則預設從 (0, 0, 0) 開始，角度為 0。
    *   這個指令同時也設定了後續未指定軌道段的物件的相對原點。
	
3.  **`straight <length> [gradient_permille]`**
    *   建立一段直線軌道。*   建立一段直線軌道。*   建立一段直線軌道。*   建立一段直線軌道。
    *   `length`: 直線軌道的水平長度。*   `length`: 直線軌道的水平長度。*   `length`: 直線軌道的水平長度。*   `length`: 直線軌道的水平長度。
    *   `gradient_permille` (可選): 軌道的坡度，單位是千分比 (‰)。正值表示上坡，負值表示下坡。預設為 0。*   `gradient_permille` (可選): 軌道的坡度，單位是千分比 (‰)。正值表示上坡，負值表示下坡。預設為 0。

4.  **`curve <radius> <angle_deg> [gradient_permille]`**
    *   建立一段彎曲軌道。
    *   `radius`: 彎道的半徑。
    *   `angle_deg`: 彎道的角度（度）。正角度通常表示向左轉，負角度向右轉（相對於當前前進方向）。
    *   `gradient_permille` (可選): 軌道的坡度，單位是千分比 (‰)。預設為 0。

### 場景物件指令

1.  **`building <x> <y> <z> <rx> <ry> <rz> <width> <depth> <height> [texture_file]`**
    *   在指定位置放置一個立方體建築。
    *   `x`, `y`, `z`: 建築物底部中心的座標。
    *   `rx`, `ry`, `rz`: 分別繞 X, Y, Z 軸的旋轉角度（度）。
    *   `width`, `depth`, `height`: 建築物的寬度 (X軸方向)、深度 (Z軸方向)、高度 (Y軸方向)。
    *   `texture_file` (可選): 指定使用的紋理檔案名稱（位於 `textures` 資料夾內）。預設為 `building.png`。

2.  **`cylinder <x> <y> <z> <rx> <ry> <rz> <radius> <height> [texture_file]`**
    *   在指定位置放置一個圓柱體。
    *   `x`, `y`, `z`: 圓柱體底部中心的座標。
    *   `rx`, `ry`, `rz`: 分別繞 X, Y, Z 軸的旋轉角度（度）。注意：OpenGL 的 `gluCylinder` 預設沿 Z 軸繪製，渲染器內部會先旋轉使其豎直（沿 Y 軸），然後再應用這裡的旋轉。
    *   `radius`: 圓柱體的半徑。
    *   `height`: 圓柱體的高度。
    *   `texture_file` (可選): 指定使用的紋理檔案名稱（位於 `textures` 資料夾內）。預設為 `metal.png`。

3.  **`tree <x> <y> <z> <height>`**
    *   在指定位置放置一棵樹（由圓柱樹幹和圓錐/球體樹葉組成）。
    *   `x`, `y`, `z`: 樹根部的座標。
    *   `height`: 樹的總高度。

### 範例 `scene.txt`

```
# 這是一個範例場景檔案

# 地圖視窗底圖
map map.png 0 0 1 # 以圖檔中心點為起點，縮放比例1:1

# 軌道定義
straight 50 5     # 前進 50 單位，上坡 5‰
curve 20 90 -2    # 左轉 90 度，半徑 20，下坡 2‰
straight 30
curve 20 -90 0    # 右轉 90 度，半徑 20，水平
straight 50 -5    # 前進 50 單位，下坡 5‰

# 場景物件
building 10 0 20  0 45 0  5 8 10 building_brick.png
building -15 0 40 0 0 0   6 6 8
cylinder 5 0 5    0 0 0   1 5 pipe.png
tree 8 0 12 6
tree -10 0 30 7
```
## 坐標系統說明
以BUILDING指令為例  
![image](https://github.com/user-attachments/assets/6123faf4-94f3-4ec0-9cab-bcdcee6830fb)  
第一組XYZ是物件在空間中的位置 最後一組XYZ是物件的尺寸 兩組XYZ的坐標軸向定義不一樣  
世界從俯瞰角度看到的是XZ平面 X+代表向左 Z+代表向前 Y+代表向天空  
物體自身的尺寸坐標 Z軸代表身高  
可以這樣來理解：3D世界是透過螢幕看進去的，所以原本螢幕的XY平面加上"深度"Z就變成立體。  
但是一般物體描述的時候，會用XY平面當作俯視圖，Z軸代表高度，因此會有一點錯亂。  
  
  
## 相對座標系統 (用於物件放置)

為了方便使用者根據軌道路線佈置場景物件（如建築、圓柱體、樹木），本模擬器採用了一套相對座標系統來定義這些物件的位置和基礎朝向。  
只要把物件放在軌道設定之後，該物件的原點就會自動設定為軌道起點。這樣就可以方便調整物件位置。  
如果要放置以世界原點為基準的物件，就把物件放在軌道起點之前就可以了。  
  
### 原理如下：  

*   **相對原點 (Relative Origin):** 當您在 `scene.txt` 中定義一個軌道段指令（`straight` 或 `curve`）之後定義物件時，該軌道段的**起始點位置**和**起始方向角度**將自動成為這些後續物件的「相對原點」。
    *   如果物件定義在任何軌道段之前，或者沒有定義 `start` 指令，則世界原點 (0, 0, 0) 和 0 度角將作為預設的相對原點。

*   **局部座標軸 (Local Axes):** 物件指令中的相對位置參數 (`rel_x`, `rel_y`, `rel_z`) 是在一個與相對原點方向對齊的**局部座標系**中解釋的：
    *   `rel_z`: 代表沿著相對原點**前進方向**的距離。
    *   `rel_x`: 代表沿著相對原點**右側方向**的距離。
    *   `rel_y`: 代表沿著**世界 Y 軸向上**的距離（高度偏移）。

*   **相對 Y 軸旋轉 (Relative Yaw):** 物件指令中的相對 Y 軸旋轉參數 (`rel_ry`，以度為單位) 會疊加到相對原點的角度上，共同決定了該物件最終在世界中的基礎 Y 軸朝向。

*   **轉換過程:** `scene_parser.py` 負責將這些相對於軌道段的定義（相對位置、相對旋轉）轉換為每個物件最終的**絕對世界座標**和**絕對世界旋轉角度**。這個轉換過程會正確地考慮相對原點的旋轉，確保 `rel_x` 和 `rel_z` 始終是根據軌道方向進行偏移。

*   **優點:** 這個系統的主要目的是讓使用者可以更直觀地思考物件的位置。例如，不論軌道指向哪個方向，`building 5 0 10 ...` 的定義始終意味著將建築放置在軌道段起點的「右側 5 單位、前方 10 單位」的位置。

*   **其他旋轉 (`rx`, `rz`):** 物件的 X 軸旋轉 (`rx`, Pitch) 和 Z 軸旋轉 (`rz`, Roll) 參數則是在物件已經根據其最終的世界 Y 軸朝向對齊後，再相對於其自身的局部軸應用的。

**簡而言之：您只需考慮物件相對於軌道起點的「前、後、左、右、上、下」以及相對於軌道方向的「額外轉向」，解析器會自動計算出它們在複雜 3D 世界中的最終位置和朝向。**


## 紋理

*   所有紋理檔案（建議使用 `.png` 格式）應放置在名為 `textures` 的子資料夾中。
*   真實地圖檔案map.png同樣放置在名為 `textures` 的子資料夾中。
*   程式會自動載入 `scene.txt` 中指定的紋理，或使用預設紋理。

---

